{"version":3,"file":"projetvet_form.min.js","sources":["../src/projetvet_form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Activity entry form modal\n *\n * @module     mod_projetvet/projetvet_form\n * @copyright  2025 Bas Brands <bas@sonsbeekmedia.nl>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\nimport Notification from 'core/notification';\nimport Repository from 'mod_projetvet/repository';\nimport Templates from 'core/templates';\n\n/**\n * Get the hours per ECTS setting from the page config\n * @returns {number}\n */\nconst getHoursPerEcts = () => {\n    // The value is set via $PAGE->requires->data_for_js() in view.php.\n    if (typeof M !== 'undefined' && M.cfg && M.cfg.hoursPerEcts) {\n        return parseInt(M.cfg.hoursPerEcts) || 30;\n    }\n    return 30;\n};\n\n/**\n * Initialize ECTS suggestion listeners\n * @param {number} hoursPerEcts - The hours per ECTS credit ratio\n */\nconst initEctsSuggestion = (hoursPerEcts) => {\n    // Find all number inputs with data-action=\"suggestedects\".\n    const inputs = document.querySelectorAll('input[type=\"number\"][data-action=\"suggestedects\"]');\n\n    inputs.forEach(input => {\n        const suggestionDiv = document.getElementById(input.id + '_suggestion');\n        if (!suggestionDiv) {\n            return;\n        }\n\n        // Update suggestion when user types.\n        const updateSuggestion = async() => {\n            const hours = parseFloat(input.value);\n            if (isNaN(hours) || hours <= 0) {\n                suggestionDiv.innerHTML = '';\n                return;\n            }\n\n            const suggestedEcts = (hours / hoursPerEcts).toFixed(0);\n            const message = await getString('suggested_credits', 'mod_projetvet', suggestedEcts);\n            suggestionDiv.innerHTML = message;\n        };\n\n        // Listen for input changes.\n        input.addEventListener('input', updateSuggestion);\n\n        // Update immediately if there's already a value.\n        if (input.value) {\n            updateSuggestion();\n        }\n    });\n};\n\nexport const init = async() => {\n    // Get the hours per ECTS setting once on init.\n    const hoursPerEcts = getHoursPerEcts();\n\n    const submitEventHandler = () => {\n        window.location.reload();\n    };\n\n    // Handle create/edit activity button clicks.\n    document.addEventListener('click', (event) => {\n        if (!event.target.closest('[data-action=\"activity-entry-form\"]')) {\n            return;\n        }\n        const button = event.target.closest('[data-action=\"activity-entry-form\"]');\n        event.preventDefault();\n\n        const modalForm = new ModalForm({\n            moduleName: 'core/modal',\n            formClass: '\\\\mod_projetvet\\\\form\\\\projetvet_form',\n            args: {\n                ...button.dataset,\n            },\n        });\n\n        // Add custom class to modal after it's loaded.\n        modalForm.addEventListener(modalForm.events.LOADED, () => {\n            modalForm.modal.getModal().addClass('modal-fullscreen-form');\n            modalForm.modal.getRoot().on('modal:bodyRendered', () => {\n                // Initialize ECTS suggestion listeners.\n                initEctsSuggestion(hoursPerEcts);\n            });\n        });\n\n        // Intercept form submission to show dialog only if switch is not checked.\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, submitEventHandler);\n        modalForm.show();\n    });\n\n    // Make entry table rows clickable - trigger the edit/view action when row is clicked.\n    document.addEventListener('click', (event) => {\n        const row = event.target.closest('tr.projetvet-entry-row');\n        if (!row) {\n            return;\n        }\n\n        // Don't trigger if clicking on an action button within the row.\n        if (event.target.closest('[data-action]') || event.target.closest('.action-menu')) {\n            return;\n        }\n\n        event.preventDefault();\n\n        // Remove highlight from all rows, then add to clicked row.\n        document.querySelectorAll('tr.row-highlight').forEach(r => r.classList.remove('row-highlight'));\n        row.classList.add('row-highlight');\n\n        // Find the edit button in this row to get the data attributes.\n        const editButton = row.querySelector('[data-action=\"activity-entry-form\"][data-readonly=\"0\"]');\n        if (!editButton) {\n            return;\n        }\n\n        const modalForm = new ModalForm({\n            moduleName: 'core/modal',\n            formClass: '\\\\mod_projetvet\\\\form\\\\projetvet_form',\n            args: {\n                ...editButton.dataset,\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.LOADED, () => {\n            modalForm.modal.getModal().addClass('modal-fullscreen-form');\n            // Initialize ECTS suggestion listeners.\n            initEctsSuggestion(hoursPerEcts);\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, submitEventHandler);\n        modalForm.show();\n    });\n\n    // Handle subset entry form button clicks (forms within forms).\n    document.addEventListener('click', (event) => {\n        if (!event.target.closest('[data-action=\"subset-entry-form\"]')) {\n            return;\n        }\n        const button = event.target.closest('[data-action=\"subset-entry-form\"]');\n        event.preventDefault();\n\n        const modalForm = new ModalForm({\n            moduleName: 'core/modal',\n            formClass: '\\\\mod_projetvet\\\\form\\\\projetvet_form',\n            args: {\n                ...button.dataset,\n            },\n        });\n\n        // Initialize ECTS suggestion listeners after modal loads.\n        modalForm.addEventListener(modalForm.events.LOADED, () => {\n            initEctsSuggestion(hoursPerEcts);\n        });\n\n        // After form submission, reload the subset entries list via AJAX.\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, async() => {\n            // Get the element ID and container.\n            const elementId = button.dataset.elementid;\n            const listContainer = document.querySelector(`#${elementId}_list`);\n\n            if (!listContainer) {\n                return;\n            }\n\n            try {\n                // Fetch updated entry list from the webservice.\n                const data = await Repository.getEntryList({\n                    projetvetid: parseInt(button.dataset.projetvetid),\n                    studentid: parseInt(button.dataset.studentid),\n                    formsetidnumber: button.dataset.formsetidnumber,\n                    parententryid: parseInt(button.dataset.parententryid),\n                });\n\n                // Build context for the partial template.\n                const context = {\n                    hasentries: data.activities && data.activities.length > 0,\n                    entries: data.activities && data.activities.length > 0 ? {\n                        headers: data.listfields.map(field => ({name: field.name})),\n                        rows: data.activities.map(activity => ({\n                            id: activity.id,\n                            fields: activity.fields.map(field => ({value: field.displayvalue})),\n                        })),\n                    } : null,\n                    subsetformsetidnumber: button.dataset.formsetidnumber,\n                    parententryid: button.dataset.parententryid,\n                    studentid: button.dataset.studentid,\n                    cmid: button.dataset.cmid,\n                    projetvetid: button.dataset.projetvetid,\n                    elementid: elementId,\n                };\n\n                // Re-render the entry list using the partial template.\n                const {html, js} = await Templates.renderForPromise(\n                    'mod_projetvet/form/element_subset_entries',\n                    context\n                );\n                Templates.replaceNodeContents(listContainer, html, js);\n            } catch (error) {\n                Notification.exception(error);\n            }\n        });\n\n        modalForm.show();\n    });\n\n    // Handle form button clicks for save/submit actions.\n    document.addEventListener('click', (event) => {\n        if (!event.target.closest('.projetvet-form-button')) {\n            return;\n        }\n        const button = event.target.closest('.projetvet-form-button');\n        event.preventDefault();\n\n        const entrystatus = button.dataset.entrystatus;\n        const actionType = button.dataset.actionType;\n        const form = button.closest('form');\n\n        // Handle email action.\n        if (actionType === 'email' && form) {\n            const studentEmailInput = form.querySelector('input[name=\"studentemail\"]');\n            if (studentEmailInput && studentEmailInput.value) {\n                const email = studentEmailInput.value;\n                const activityTitleInput = form.querySelector('input[name=\"activity_title\"]');\n                const activityTitle = activityTitleInput ? activityTitleInput.value : 'votre activité';\n                const subject = encodeURIComponent('Discussion concernant: ' + activityTitle);\n                const body = encodeURIComponent('Bonjour,\\n\\nJe souhaiterais discuter avec vous concernant votre activité.\\n\\n');\n                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;\n            }\n            return;\n        }\n\n        if (form) {\n            // Add a hidden field to indicate button submission.\n            let buttonField = form.querySelector('input[name=\"button_entrystatus\"]');\n            if (!buttonField) {\n                buttonField = document.createElement('input');\n                buttonField.type = 'hidden';\n                buttonField.name = 'button_entrystatus';\n                form.appendChild(buttonField);\n            }\n            buttonField.value = entrystatus;\n\n            // Submit the form.\n            form.dispatchEvent(new Event('submit', {bubbles: true, cancelable: true}));\n        }\n    });\n\n    // Handle delete activity button clicks.\n    document.addEventListener('click', async(event) => {\n        if (!event.target.closest('[data-action=\"delete-activity\"]')) {\n            return;\n        }\n        event.preventDefault();\n\n        const button = event.target.closest('[data-action=\"delete-activity\"]');\n        const entryid = button.dataset.entryid;\n\n        if (!entryid) {\n            return;\n        }\n\n        const confirmString = await getString('confirmdeleteactivity', 'mod_projetvet');\n\n        Notification.confirm(\n            getString('confirm'),\n            confirmString,\n            getString('delete'),\n            getString('cancel'),\n            async() => {\n                try {\n                    await Repository.deleteEntry({entryid: parseInt(entryid)});\n                    window.location.reload();\n                } catch (error) {\n                    Notification.exception(error);\n                }\n            }\n        );\n    });\n};\n"],"names":["initEctsSuggestion","hoursPerEcts","document","querySelectorAll","forEach","input","suggestionDiv","getElementById","id","updateSuggestion","async","hours","parseFloat","value","isNaN","innerHTML","suggestedEcts","toFixed","message","addEventListener","M","cfg","parseInt","submitEventHandler","window","location","reload","event","target","closest","button","preventDefault","modalForm","ModalForm","moduleName","formClass","args","dataset","events","LOADED","modal","getModal","addClass","getRoot","on","FORM_SUBMITTED","show","row","r","classList","remove","add","editButton","querySelector","elementId","elementid","listContainer","data","Repository","getEntryList","projetvetid","studentid","formsetidnumber","parententryid","context","hasentries","activities","length","entries","headers","listfields","map","field","name","rows","activity","fields","displayvalue","subsetformsetidnumber","cmid","html","js","Templates","renderForPromise","replaceNodeContents","error","exception","entrystatus","actionType","form","studentEmailInput","email","activityTitleInput","activityTitle","subject","encodeURIComponent","body","href","buttonField","createElement","type","appendChild","dispatchEvent","Event","bubbles","cancelable","entryid","confirmString","confirm","deleteEntry"],"mappings":"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"}