{"version":3,"file":"projetvet_form.min.js","sources":["../src/projetvet_form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Activity entry form modal\n *\n * @module     mod_projetvet/projetvet_form\n * @copyright  2025 Bas Brands <bas@sonsbeekmedia.nl>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\nimport Notification from 'core/notification';\nimport Repository from 'mod_projetvet/repository';\nimport Templates from 'core/templates';\n\nexport const init = () => {\n\n    const submitEventHandler = () => {\n        window.location.reload();\n    };\n\n    // Handle create/edit activity button clicks.\n    document.addEventListener('click', (event) => {\n        if (!event.target.closest('[data-action=\"activity-entry-form\"]')) {\n            return;\n        }\n        const button = event.target.closest('[data-action=\"activity-entry-form\"]');\n        event.preventDefault();\n\n        const modalForm = new ModalForm({\n            moduleName: 'core/modal',\n            formClass: '\\\\mod_projetvet\\\\form\\\\projetvet_form',\n            args: {\n                ...button.dataset,\n            },\n        });\n\n        // Add custom class to modal after it's loaded.\n        modalForm.addEventListener(modalForm.events.LOADED, () => {\n            modalForm.modal.getModal().addClass('modal-fullscreen-form');\n        });\n\n        // Intercept form submission to show dialog only if switch is not checked.\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, submitEventHandler);\n        modalForm.show();\n    });\n\n    // Make entry table rows clickable - trigger the edit/view action when row is clicked.\n    document.addEventListener('click', (event) => {\n        const row = event.target.closest('tr.projetvet-entry-row');\n        if (!row) {\n            return;\n        }\n\n        // Don't trigger if clicking on an action button within the row.\n        if (event.target.closest('[data-action]') || event.target.closest('.action-menu')) {\n            return;\n        }\n\n        event.preventDefault();\n\n        // Find the edit button in this row to get the data attributes.\n        const editButton = row.querySelector('[data-action=\"activity-entry-form\"][data-readonly=\"0\"]');\n        if (!editButton) {\n            return;\n        }\n\n        const modalForm = new ModalForm({\n            moduleName: 'core/modal',\n            formClass: '\\\\mod_projetvet\\\\form\\\\projetvet_form',\n            args: {\n                ...editButton.dataset,\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.LOADED, () => {\n            modalForm.modal.getModal().addClass('modal-fullscreen-form');\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, submitEventHandler);\n        modalForm.show();\n    });\n\n    // Handle subset entry form button clicks (forms within forms).\n    document.addEventListener('click', (event) => {\n        if (!event.target.closest('[data-action=\"subset-entry-form\"]')) {\n            return;\n        }\n        const button = event.target.closest('[data-action=\"subset-entry-form\"]');\n        event.preventDefault();\n\n        const modalForm = new ModalForm({\n            moduleName: 'core/modal',\n            formClass: '\\\\mod_projetvet\\\\form\\\\projetvet_form',\n            args: {\n                ...button.dataset,\n            },\n        });\n\n        // After form submission, reload the subset entries list via AJAX.\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, async() => {\n            // Get the element ID and container.\n            const elementId = button.dataset.elementid;\n            const listContainer = document.querySelector(`#${elementId}_list`);\n\n            if (!listContainer) {\n                return;\n            }\n\n            try {\n                // Fetch updated entry list from the webservice.\n                const data = await Repository.getEntryList({\n                    projetvetid: parseInt(button.dataset.projetvetid),\n                    studentid: parseInt(button.dataset.studentid),\n                    formsetidnumber: button.dataset.formsetidnumber,\n                    parententryid: parseInt(button.dataset.parententryid),\n                });\n\n                // Build context for the partial template.\n                const context = {\n                    hasentries: data.activities && data.activities.length > 0,\n                    entries: data.activities && data.activities.length > 0 ? {\n                        headers: data.listfields.map(field => ({name: field.name})),\n                        rows: data.activities.map(activity => ({\n                            id: activity.id,\n                            fields: activity.fields.map(field => ({value: field.displayvalue})),\n                        })),\n                    } : null,\n                    subsetformsetidnumber: button.dataset.formsetidnumber,\n                    parententryid: button.dataset.parententryid,\n                    studentid: button.dataset.studentid,\n                    cmid: button.dataset.cmid,\n                    projetvetid: button.dataset.projetvetid,\n                    elementid: elementId,\n                };\n\n                // Re-render the entry list using the partial template.\n                const {html, js} = await Templates.renderForPromise(\n                    'mod_projetvet/form/element_subset_entries',\n                    context\n                );\n                Templates.replaceNodeContents(listContainer, html, js);\n            } catch (error) {\n                Notification.exception(error);\n            }\n        });\n\n        modalForm.show();\n    });\n\n    // Handle form button clicks for save/submit actions.\n    document.addEventListener('click', (event) => {\n        if (!event.target.closest('.projetvet-form-button')) {\n            return;\n        }\n        const button = event.target.closest('.projetvet-form-button');\n        event.preventDefault();\n\n        const entrystatus = button.dataset.entrystatus;\n        const actionType = button.dataset.actionType;\n        const form = button.closest('form');\n\n        // Handle email action.\n        if (actionType === 'email' && form) {\n            const studentEmailInput = form.querySelector('input[name=\"studentemail\"]');\n            if (studentEmailInput && studentEmailInput.value) {\n                const email = studentEmailInput.value;\n                const activityTitleInput = form.querySelector('input[name=\"activity_title\"]');\n                const activityTitle = activityTitleInput ? activityTitleInput.value : 'votre activité';\n                const subject = encodeURIComponent('Discussion concernant: ' + activityTitle);\n                const body = encodeURIComponent('Bonjour,\\n\\nJe souhaiterais discuter avec vous concernant votre activité.\\n\\n');\n                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;\n            }\n            return;\n        }\n\n        if (form) {\n            // Add a hidden field to indicate button submission.\n            let buttonField = form.querySelector('input[name=\"button_entrystatus\"]');\n            if (!buttonField) {\n                buttonField = document.createElement('input');\n                buttonField.type = 'hidden';\n                buttonField.name = 'button_entrystatus';\n                form.appendChild(buttonField);\n            }\n            buttonField.value = entrystatus;\n\n            // Submit the form.\n            form.dispatchEvent(new Event('submit', {bubbles: true, cancelable: true}));\n        }\n    });\n\n    // Handle delete activity button clicks.\n    document.addEventListener('click', async(event) => {\n        if (!event.target.closest('[data-action=\"delete-activity\"]')) {\n            return;\n        }\n        event.preventDefault();\n\n        const button = event.target.closest('[data-action=\"delete-activity\"]');\n        const entryid = button.dataset.entryid;\n\n        if (!entryid) {\n            return;\n        }\n\n        const confirmString = await getString('confirmdeleteactivity', 'mod_projetvet');\n\n        Notification.confirm(\n            getString('confirm'),\n            confirmString,\n            getString('delete'),\n            getString('cancel'),\n            async() => {\n                try {\n                    await Repository.deleteEntry({entryid: parseInt(entryid)});\n                    window.location.reload();\n                } catch (error) {\n                    Notification.exception(error);\n                }\n            }\n        );\n    });\n};\n"],"names":["submitEventHandler","window","location","reload","document","addEventListener","event","target","closest","button","preventDefault","modalForm","ModalForm","moduleName","formClass","args","dataset","events","LOADED","modal","getModal","addClass","FORM_SUBMITTED","show","row","editButton","querySelector","async","elementId","elementid","listContainer","data","Repository","getEntryList","projetvetid","parseInt","studentid","formsetidnumber","parententryid","context","hasentries","activities","length","entries","headers","listfields","map","field","name","rows","activity","id","fields","value","displayvalue","subsetformsetidnumber","cmid","html","js","Templates","renderForPromise","replaceNodeContents","error","exception","entrystatus","actionType","form","studentEmailInput","email","activityTitleInput","activityTitle","subject","encodeURIComponent","body","href","buttonField","createElement","type","appendChild","dispatchEvent","Event","bubbles","cancelable","entryid","confirmString","confirm","deleteEntry"],"mappings":"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"}