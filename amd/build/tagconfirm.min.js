define("mod_projetvet/tagconfirm",["exports","core/templates"],(function(_exports,_templates){var obj;
/**
   * Tag confirmation form element with add competence feature.
   *
   * @module     mod_projetvet/tagconfirm
   * @copyright  2025 Bas Brands <bas@sonsbeekmedia.nl>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_templates=(obj=_templates)&&obj.__esModule?obj:{default:obj};class TagConfirm{constructor(elementId,elementName){var _this$popup,_this$popup2;this.elementId=elementId,this.elementName=elementName,this.wrapper=document.querySelector('[data-element-id="'.concat(elementId,'"]')),this.wrapper&&(this.popup=this.wrapper.querySelector('[data-region="tagconfirm-popup"]'),this.searchInput=null===(_this$popup=this.popup)||void 0===_this$popup?void 0:_this$popup.querySelector('[data-region="tagconfirm-search"]'),this.selectedAdditionsPopup=null===(_this$popup2=this.popup)||void 0===_this$popup2?void 0:_this$popup2.querySelector('[data-region="selected-additions-popup"]'),this.table=this.wrapper.querySelector('[data-region="tagconfirm-table"]'),this.tbody=this.wrapper.querySelector('[data-region="tagconfirm-tbody"]'),this.tempSelections=new Set,this.addEventListeners())}addEventListeners(){var _this$wrapper$querySe,_this$popup3,_this$popup4,_this$popup4$querySel,_this$popup5,_this$popup6,_this$searchInput;null===(_this$wrapper$querySe=this.wrapper.querySelector('[data-action="open-tagconfirm-popup"]'))||void 0===_this$wrapper$querySe||_this$wrapper$querySe.addEventListener("click",(()=>{this.openPopup()})),null===(_this$popup3=this.popup)||void 0===_this$popup3||_this$popup3.querySelectorAll('[data-action="close-tagconfirm-popup"]').forEach((btn=>{btn.addEventListener("click",(()=>{this.closePopup()}))})),null===(_this$popup4=this.popup)||void 0===_this$popup4||null===(_this$popup4$querySel=_this$popup4.querySelector('[data-action="save-tagconfirm-additions"]'))||void 0===_this$popup4$querySel||_this$popup4$querySel.addEventListener("click",(()=>{this.saveAdditions()})),null===(_this$popup5=this.popup)||void 0===_this$popup5||_this$popup5.querySelectorAll('[data-action="select-addition"]').forEach((link=>{link.addEventListener("click",(e=>{e.preventDefault();const tagId=link.dataset.tagId,tagName=link.dataset.tagName;this.addTempSelection(tagId,tagName)}))})),null===(_this$popup6=this.popup)||void 0===_this$popup6||_this$popup6.addEventListener("click",(e=>{const removeBtn=e.target.closest('[data-action="remove-temp-selection"]');if(removeBtn){e.preventDefault();const tagId=removeBtn.dataset.tagId;this.removeTempSelection(tagId)}})),null===(_this$searchInput=this.searchInput)||void 0===_this$searchInput||_this$searchInput.addEventListener("input",(()=>{this.filterTags()}))}openPopup(){var _this$searchInput2;this.popup.classList.remove("d-none"),null===(_this$searchInput2=this.searchInput)||void 0===_this$searchInput2||_this$searchInput2.focus(),this.tempSelections.clear(),this.selectedAdditionsPopup.innerHTML=""}closePopup(){this.popup.classList.add("d-none"),this.searchInput.value="",this.filterTags(),this.tempSelections.clear(),this.selectedAdditionsPopup.innerHTML=""}async addTempSelection(tagId,tagName){if(this.tbody.querySelector('input[data-tag-id="'.concat(tagId,'"]')))return;if(this.tempSelections.has(tagId))return;this.tempSelections.add(tagId);const context={tagid:tagId,tagname:tagName,action:"remove-temp-selection"},{html:html,js:js}=await _templates.default.renderForPromise("mod_projetvet/tagselect_badge",context);_templates.default.appendNodeContents(this.selectedAdditionsPopup,html,js)}removeTempSelection(tagId){this.tempSelections.delete(tagId);const badge=this.selectedAdditionsPopup.querySelector('[data-tag-id="'.concat(tagId,'"]'));badge&&badge.closest(".badge").remove()}async saveAdditions(){if(0===this.tempSelections.size)return void this.closePopup();const allLinks=this.popup.querySelector('[data-region="tagconfirm-tag-list"]').querySelectorAll('[data-action="select-addition"]'),groupedAdditions=new Map;allLinks.forEach((link=>{const tagId=link.dataset.tagId;if(this.tempSelections.has(tagId)){const tagName=link.dataset.tagName;let groupHeading="",prev=link.previousElementSibling;for(;prev;){if(prev.classList.contains("bg-light")){var _prev$querySelector;groupHeading=(null===(_prev$querySelector=prev.querySelector("div"))||void 0===_prev$querySelector?void 0:_prev$querySelector.textContent)||"";break}prev=prev.previousElementSibling}groupedAdditions.has(groupHeading)||groupedAdditions.set(groupHeading,[]),groupedAdditions.get(groupHeading).push({tagId:tagId,tagName:tagName})}}));for(const[groupHeading,items]of groupedAdditions){let groupRow=null;this.tbody.querySelectorAll("tr.table-active").forEach((row=>{var _row$querySelector;(null===(_row$querySelector=row.querySelector("strong"))||void 0===_row$querySelector?void 0:_row$querySelector.textContent)===groupHeading&&(groupRow=row)})),groupRow||(groupRow=document.createElement("tr"),groupRow.className="table-active",groupRow.innerHTML='<td colspan="2"><strong>'.concat(groupHeading,"</strong></td>"),this.tbody.appendChild(groupRow));for(const{tagId:tagId,tagName:tagName}of items){const row=document.createElement("tr");row.setAttribute("data-tag-id",tagId),row.innerHTML="\n                    <td>".concat(tagName,'</td>\n                    <td class="text-center">\n                        <input type="checkbox"\n                               name="').concat(this.elementName,"[").concat(tagId,']"\n                               id="').concat(this.elementId,"_").concat(tagId,'"\n                               value="1"\n                               checked\n                               class="tagconfirm-checkbox"\n                               data-tag-id="').concat(tagId,'">\n                    </td>\n                '),groupRow.insertAdjacentElement("afterend",row)}}this.closePopup()}filterTags(){const searchTerm=this.searchInput.value.toLowerCase();this.popup.querySelector('[data-region="tagconfirm-tag-list"]').querySelectorAll('[data-action="select-addition"]').forEach((item=>{item.dataset.tagName.toLowerCase().includes(searchTerm)?(item.classList.remove("d-none"),this.highlightMatch(item,searchTerm)):item.classList.add("d-none")}))}highlightMatch(element,searchTerm){const tagName=element.dataset.tagName;if(!searchTerm)return void(element.innerHTML=tagName);const index=tagName.toLowerCase().indexOf(searchTerm);if(-1===index)return void(element.innerHTML=tagName);const before=tagName.slice(0,index),match=tagName.slice(index,index+searchTerm.length),after=tagName.slice(index+searchTerm.length);element.innerHTML="".concat(before,"<strong>").concat(match,"</strong>").concat(after)}}var _default={init:(elementId,elementName)=>{new TagConfirm(elementId,elementName)}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=tagconfirm.min.js.map