{"version":3,"file":"tagselect.min.js","sources":["../src/tagselect.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tag select form element helpers.\n *\n * @module     mod_projetvet/tagselect\n * @copyright  2025 Bas Brands <bas@sonsbeekmedia.nl>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\n\nclass TagSelect {\n\n    /**\n     * Constructor.\n     *\n     * @param {string} elementId The ID of the select element\n     * @param {number} maxTags Maximum number of tags (0 = unlimited)\n     */\n    constructor(elementId, maxTags) {\n        this.elementId = elementId;\n        this.maxTags = maxTags || 0;\n        this.selectElement = document.getElementById(elementId);\n        this.wrapper = document.querySelector(`[data-element-id=\"${elementId}\"]`);\n\n        if (!this.selectElement || !this.wrapper) {\n            return;\n        }\n\n        this.popup = this.wrapper.querySelector('[data-region=\"tagselect-popup\"]');\n        this.searchInput = this.popup.querySelector('[data-region=\"tag-search\"]');\n        this.selectedTagsDisplay = this.wrapper.querySelector('[data-region=\"selected-tags-display\"]');\n        this.selectedTagsPopup = this.popup.querySelector('[data-region=\"selected-tags-popup\"]');\n        this.tagCount = this.wrapper.querySelector('[data-region=\"tag-count\"]');\n        this.warningsRegion = this.popup.querySelector('[data-region=\"warnings\"]');\n\n        this.addEventListeners();\n    }\n\n    /**\n     * Add event listeners.\n     */\n    addEventListeners() {\n        // Open popup.\n        this.wrapper.querySelector('[data-action=\"open-tagselect\"]')?.addEventListener('click', () => {\n            this.openPopup();\n        });\n\n        // Close popup.\n        this.popup.querySelectorAll('[data-action=\"close-tagselect\"]').forEach(btn => {\n            btn.addEventListener('click', () => {\n                this.closePopup();\n            });\n        });\n\n        // Save tags.\n        this.popup.querySelector('[data-action=\"save-tags\"]')?.addEventListener('click', () => {\n            this.saveTags();\n        });\n\n        // Select tag from list.\n        this.popup.querySelectorAll('[data-action=\"select-tag\"]').forEach(link => {\n            link.addEventListener('click', (e) => {\n                e.preventDefault();\n                const tagId = link.dataset.tagId;\n                const tagName = link.dataset.tagName;\n                this.addTag(tagId, tagName);\n            });\n        });\n\n        // Remove tag (display).\n        this.wrapper.addEventListener('click', (e) => {\n            const removeBtn = e.target.closest('[data-action=\"remove-tag\"]');\n            if (removeBtn) {\n                e.preventDefault();\n                const tagId = removeBtn.dataset.tagId;\n                this.removeTag(tagId);\n            }\n        });\n\n        // Remove tag (popup).\n        this.popup.addEventListener('click', (e) => {\n            const removeBtn = e.target.closest('[data-action=\"remove-tag-popup\"]');\n            if (removeBtn) {\n                e.preventDefault();\n                const tagId = removeBtn.dataset.tagId;\n                this.removeTag(tagId);\n            }\n        });\n\n        // Search/filter.\n        this.searchInput?.addEventListener('input', () => {\n            this.filterTags();\n        });\n\n        // Toggle all.\n        this.popup.querySelector('[data-action=\"toggle-all\"]')?.addEventListener('click', () => {\n            this.toggleAll();\n        });\n    }\n\n    /**\n     * Open the popup.\n     */\n    openPopup() {\n        this.popup.classList.remove('d-none');\n        this.searchInput?.focus();\n    }\n\n    /**\n     * Close the popup.\n     */\n    closePopup() {\n        this.popup.classList.add('d-none');\n        this.searchInput.value = '';\n        this.filterTags();\n    }\n\n    /**\n     * Save tags and close popup.\n     */\n    saveTags() {\n        this.updateDisplay();\n        this.closePopup();\n    }\n\n    /**\n     * Add a tag.\n     *\n     * @param {string} tagId\n     * @param {string} tagName\n     */\n    addTag(tagId, tagName) {\n        // Check if already selected.\n        const option = this.selectElement.querySelector(`option[value=\"${tagId}\"]`);\n        if (option && option.selected) {\n            return;\n        }\n\n        // Check max tags limit.\n        const selectedCount = this.selectElement.querySelectorAll('option:checked').length;\n        if (this.maxTags > 0 && selectedCount >= this.maxTags) {\n            this.updateWarnings(true);\n            return;\n        }\n\n        // Select the option.\n        if (option) {\n            option.selected = true;\n        }\n\n        // Add to popup display.\n        this.addTagBadge(tagId, tagName, this.selectedTagsPopup);\n\n        // Update count and warnings.\n        this.updateCount();\n        this.updateWarnings(false);\n    }\n\n    /**\n     * Remove a tag.\n     *\n     * @param {string} tagId\n     */\n    removeTag(tagId) {\n        const option = this.selectElement.querySelector(`option[value=\"${tagId}\"]`);\n        if (option) {\n            option.selected = false;\n        }\n\n        // Remove from popup display.\n        const popupBadge = this.selectedTagsPopup.querySelector(`[data-tag-id=\"${tagId}\"]`);\n        if (popupBadge) {\n            popupBadge.remove();\n        }\n\n        // Remove from main display.\n        const displayBadges = this.selectedTagsDisplay.querySelectorAll(`[data-action=\"remove-tag\"]`);\n        displayBadges.forEach(btn => {\n            if (btn.dataset.tagId === tagId) {\n                btn.closest('.badge').remove();\n            }\n        });\n\n        // Update count and warnings.\n        this.updateCount();\n        this.updateWarnings(false);\n    }\n\n    /**\n     * Add a tag badge to a container.\n     *\n     * @param {string} tagId\n     * @param {string} tagName\n     * @param {HTMLElement} container\n     */\n    async addTagBadge(tagId, tagName, container) {\n        // Check if already exists.\n        if (container.querySelector(`[data-tag-id=\"${tagId}\"]`)) {\n            return;\n        }\n\n        const action = container === this.selectedTagsPopup ? 'remove-tag-popup' : 'remove-tag';\n        const context = {\n            tagid: tagId,\n            tagname: tagName,\n            action: action\n        };\n\n        const {html, js} = await Templates.renderForPromise('mod_projetvet/tagselect_badge', context);\n        Templates.appendNodeContents(container, html, js);\n    }\n\n    /**\n     * Update the main display.\n     */\n    async updateDisplay() {\n        this.selectedTagsDisplay.innerHTML = '';\n        const selectedOptions = this.selectElement.querySelectorAll('option:checked');\n\n        for (const option of selectedOptions) {\n            const context = {\n                tagid: option.value,\n                tagname: option.textContent,\n                action: 'remove-tag'\n            };\n            const {html, js} = await Templates.renderForPromise('mod_projetvet/tagselect_badge', context);\n            Templates.appendNodeContents(this.selectedTagsDisplay, html, js);\n        }\n    }\n\n    /**\n     * Update the tag count.\n     */\n    updateCount() {\n        const count = this.selectElement.querySelectorAll('option:checked').length;\n        if (this.tagCount) {\n            this.tagCount.textContent = count;\n        }\n    }\n\n    /**\n     * Update warnings display.\n     *\n     * @param {boolean} showMaxWarning\n     */\n    updateWarnings(showMaxWarning) {\n        if (!this.warningsRegion) {\n            return;\n        }\n\n        if (showMaxWarning && this.maxTags > 0) {\n            this.warningsRegion.textContent = `Maximum of ${this.maxTags} selections allowed.`;\n            this.warningsRegion.classList.remove('d-none');\n        } else {\n            this.warningsRegion.textContent = '';\n            this.warningsRegion.classList.add('d-none');\n        }\n    }\n\n    /**\n     * Filter tags based on search input.\n     */\n    filterTags() {\n        const searchTerm = this.searchInput.value.toLowerCase();\n        const tagList = this.popup.querySelector('[data-region=\"tag-list\"]');\n        const items = tagList.querySelectorAll('[data-action=\"select-tag\"]');\n\n        items.forEach(item => {\n            const tagName = item.dataset.tagName.toLowerCase();\n            if (tagName.includes(searchTerm)) {\n                item.classList.remove('d-none');\n                this.highlightMatch(item, searchTerm);\n            } else {\n                item.classList.add('d-none');\n            }\n        });\n    }\n\n    /**\n     * Highlight matching text.\n     *\n     * @param {HTMLElement} element\n     * @param {string} searchTerm\n     */\n    highlightMatch(element, searchTerm) {\n        const tagName = element.dataset.tagName;\n        if (!searchTerm) {\n            element.innerHTML = tagName;\n            return;\n        }\n\n        const index = tagName.toLowerCase().indexOf(searchTerm);\n        if (index === -1) {\n            element.innerHTML = tagName;\n            return;\n        }\n\n        const before = tagName.slice(0, index);\n        const match = tagName.slice(index, index + searchTerm.length);\n        const after = tagName.slice(index + searchTerm.length);\n        element.innerHTML = `${before}<strong>${match}</strong>${after}`;\n    }\n\n    /**\n     * Toggle all visible tags.\n     */\n    toggleAll() {\n        const tagList = this.popup.querySelector('[data-region=\"tag-list\"]');\n        const visibleItems = tagList.querySelectorAll('[data-action=\"select-tag\"]:not(.d-none)');\n\n        visibleItems.forEach(item => {\n            const tagId = item.dataset.tagId;\n            const tagName = item.dataset.tagName;\n            const option = this.selectElement.querySelector(`option[value=\"${tagId}\"]`);\n\n            if (option && !option.selected) {\n                this.addTag(tagId, tagName);\n            }\n        });\n    }\n}\n\nconst init = (elementId, maxTags) => {\n    new TagSelect(elementId, maxTags);\n};\n\nexport default {\n    init: init\n};\n"],"names":["TagSelect","constructor","elementId","maxTags","selectElement","document","getElementById","wrapper","querySelector","this","popup","searchInput","selectedTagsDisplay","selectedTagsPopup","tagCount","warningsRegion","addEventListeners","addEventListener","openPopup","querySelectorAll","forEach","btn","closePopup","saveTags","link","e","preventDefault","tagId","dataset","tagName","addTag","removeBtn","target","closest","removeTag","filterTags","toggleAll","classList","remove","focus","add","value","updateDisplay","option","selected","selectedCount","length","updateWarnings","addTagBadge","updateCount","popupBadge","container","context","tagid","tagname","action","html","js","Templates","renderForPromise","appendNodeContents","innerHTML","selectedOptions","textContent","count","showMaxWarning","searchTerm","toLowerCase","item","includes","highlightMatch","element","index","indexOf","before","slice","match","after","init"],"mappings":";;;;;;;yJAyBMA,UAQFC,YAAYC,UAAWC,cACdD,UAAYA,eACZC,QAAUA,SAAW,OACrBC,cAAgBC,SAASC,eAAeJ,gBACxCK,QAAUF,SAASG,0CAAmCN,iBAEtDO,KAAKL,eAAkBK,KAAKF,eAI5BG,MAAQD,KAAKF,QAAQC,cAAc,wCACnCG,YAAcF,KAAKC,MAAMF,cAAc,mCACvCI,oBAAsBH,KAAKF,QAAQC,cAAc,8CACjDK,kBAAoBJ,KAAKC,MAAMF,cAAc,4CAC7CM,SAAWL,KAAKF,QAAQC,cAAc,kCACtCO,eAAiBN,KAAKC,MAAMF,cAAc,iCAE1CQ,qBAMTA,gJAEST,QAAQC,cAAc,0FAAmCS,iBAAiB,SAAS,UAC/EC,oBAIJR,MAAMS,iBAAiB,mCAAmCC,SAAQC,MACnEA,IAAIJ,iBAAiB,SAAS,UACrBK,sDAKRZ,MAAMF,cAAc,qFAA8BS,iBAAiB,SAAS,UACxEM,mBAIJb,MAAMS,iBAAiB,8BAA8BC,SAAQI,OAC9DA,KAAKP,iBAAiB,SAAUQ,IAC5BA,EAAEC,uBACIC,MAAQH,KAAKI,QAAQD,MACrBE,QAAUL,KAAKI,QAAQC,aACxBC,OAAOH,MAAOE,oBAKtBtB,QAAQU,iBAAiB,SAAUQ,UAC9BM,UAAYN,EAAEO,OAAOC,QAAQ,iCAC/BF,UAAW,CACXN,EAAEC,uBACIC,MAAQI,UAAUH,QAAQD,WAC3BO,UAAUP,gBAKlBjB,MAAMO,iBAAiB,SAAUQ,UAC5BM,UAAYN,EAAEO,OAAOC,QAAQ,uCAC/BF,UAAW,CACXN,EAAEC,uBACIC,MAAQI,UAAUH,QAAQD,WAC3BO,UAAUP,0CAKlBhB,4DAAaM,iBAAiB,SAAS,UACnCkB,oDAIJzB,MAAMF,cAAc,wFAA+BS,iBAAiB,SAAS,UACzEmB,eAOblB,wCACSR,MAAM2B,UAAUC,OAAO,0CACvB3B,8DAAa4B,QAMtBjB,kBACSZ,MAAM2B,UAAUG,IAAI,eACpB7B,YAAY8B,MAAQ,QACpBN,aAMTZ,gBACSmB,qBACApB,aASTQ,OAAOH,MAAOE,eAEJc,OAASlC,KAAKL,cAAcI,sCAA+BmB,gBAC7DgB,QAAUA,OAAOC,sBAKfC,cAAgBpC,KAAKL,cAAce,iBAAiB,kBAAkB2B,OACxErC,KAAKN,QAAU,GAAK0C,eAAiBpC,KAAKN,aACrC4C,gBAAe,IAKpBJ,SACAA,OAAOC,UAAW,QAIjBI,YAAYrB,MAAOE,QAASpB,KAAKI,wBAGjCoC,mBACAF,gBAAe,IAQxBb,UAAUP,aACAgB,OAASlC,KAAKL,cAAcI,sCAA+BmB,aAC7DgB,SACAA,OAAOC,UAAW,SAIhBM,WAAazC,KAAKI,kBAAkBL,sCAA+BmB,aACrEuB,YACAA,WAAWZ,SAIO7B,KAAKG,oBAAoBO,+CACjCC,SAAQC,MACdA,IAAIO,QAAQD,QAAUA,OACtBN,IAAIY,QAAQ,UAAUK,iBAKzBW,mBACAF,gBAAe,qBAUNpB,MAAOE,QAASsB,cAE1BA,UAAU3C,sCAA+BmB,0BAKvCyB,QAAU,CACZC,MAAO1B,MACP2B,QAASzB,QACT0B,OAJWJ,YAAc1C,KAAKI,kBAAoB,mBAAqB,eAOrE2C,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,gCAAiCP,4BAC3EQ,mBAAmBT,UAAWK,KAAMC,+BAOzC7C,oBAAoBiD,UAAY,SAC/BC,gBAAkBrD,KAAKL,cAAce,iBAAiB,sBAEvD,MAAMwB,UAAUmB,gBAAiB,OAC5BV,QAAU,CACZC,MAAOV,OAAOF,MACda,QAASX,OAAOoB,YAChBR,OAAQ,eAENC,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,gCAAiCP,4BAC3EQ,mBAAmBnD,KAAKG,oBAAqB4C,KAAMC,KAOrER,oBACUe,MAAQvD,KAAKL,cAAce,iBAAiB,kBAAkB2B,OAChErC,KAAKK,gBACAA,SAASiD,YAAcC,OASpCjB,eAAekB,gBACNxD,KAAKM,iBAINkD,gBAAkBxD,KAAKN,QAAU,QAC5BY,eAAegD,iCAA4BtD,KAAKN,qCAChDY,eAAesB,UAAUC,OAAO,iBAEhCvB,eAAegD,YAAc,QAC7BhD,eAAesB,UAAUG,IAAI,YAO1CL,mBACU+B,WAAazD,KAAKE,YAAY8B,MAAM0B,cAC1B1D,KAAKC,MAAMF,cAAc,4BACnBW,iBAAiB,8BAEjCC,SAAQgD,OACMA,KAAKxC,QAAQC,QAAQsC,cACzBE,SAASH,aACjBE,KAAK/B,UAAUC,OAAO,eACjBgC,eAAeF,KAAMF,aAE1BE,KAAK/B,UAAUG,IAAI,aAW/B8B,eAAeC,QAASL,kBACdrC,QAAU0C,QAAQ3C,QAAQC,YAC3BqC,uBACDK,QAAQV,UAAYhC,eAIlB2C,MAAQ3C,QAAQsC,cAAcM,QAAQP,gBAC7B,IAAXM,kBACAD,QAAQV,UAAYhC,eAIlB6C,OAAS7C,QAAQ8C,MAAM,EAAGH,OAC1BI,MAAQ/C,QAAQ8C,MAAMH,MAAOA,MAAQN,WAAWpB,QAChD+B,MAAQhD,QAAQ8C,MAAMH,MAAQN,WAAWpB,QAC/CyB,QAAQV,oBAAea,0BAAiBE,0BAAiBC,OAM7DzC,YACoB3B,KAAKC,MAAMF,cAAc,4BACZW,iBAAiB,2CAEjCC,SAAQgD,aACXzC,MAAQyC,KAAKxC,QAAQD,MACrBE,QAAUuC,KAAKxC,QAAQC,QACvBc,OAASlC,KAAKL,cAAcI,sCAA+BmB,aAE7DgB,SAAWA,OAAOC,eACbd,OAAOH,MAAOE,0BAUpB,CACXiD,KALS,CAAC5E,UAAWC,eACjBH,UAAUE,UAAWC"}