{"version":3,"file":"tagconfirm.min.js","sources":["../src/tagconfirm.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tag confirmation form element with add competence feature.\n *\n * @module     mod_projetvet/tagconfirm\n * @copyright  2025 Bas Brands <bas@sonsbeekmedia.nl>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\n\nclass TagConfirm {\n\n    /**\n     * Constructor.\n     *\n     * @param {string} elementId The ID of the element\n     * @param {string} elementName The name of the form element\n     */\n    constructor(elementId, elementName) {\n        this.elementId = elementId;\n        this.elementName = elementName;\n        this.wrapper = document.querySelector(`[data-element-id=\"${elementId}\"]`);\n\n        if (!this.wrapper) {\n            return;\n        }\n\n        this.popup = this.wrapper.querySelector('[data-region=\"tagconfirm-popup\"]');\n        this.searchInput = this.popup?.querySelector('[data-region=\"tagconfirm-search\"]');\n        this.selectedAdditionsPopup = this.popup?.querySelector('[data-region=\"selected-additions-popup\"]');\n        this.table = this.wrapper.querySelector('[data-region=\"tagconfirm-table\"]');\n        this.tbody = this.wrapper.querySelector('[data-region=\"tagconfirm-tbody\"]');\n\n        // Track temporarily selected additions (not yet saved).\n        this.tempSelections = new Set();\n\n        this.addEventListeners();\n    }\n\n    /**\n     * Add event listeners.\n     */\n    addEventListeners() {\n        // Open popup.\n        this.wrapper.querySelector('[data-action=\"open-tagconfirm-popup\"]')?.addEventListener('click', () => {\n            this.openPopup();\n        });\n\n        // Close popup.\n        this.popup?.querySelectorAll('[data-action=\"close-tagconfirm-popup\"]').forEach(btn => {\n            btn.addEventListener('click', () => {\n                this.closePopup();\n            });\n        });\n\n        // Save additions.\n        this.popup?.querySelector('[data-action=\"save-tagconfirm-additions\"]')?.addEventListener('click', () => {\n            this.saveAdditions();\n        });\n\n        // Select addition from list.\n        this.popup?.querySelectorAll('[data-action=\"select-addition\"]').forEach(link => {\n            link.addEventListener('click', (e) => {\n                e.preventDefault();\n                const tagId = link.dataset.tagId;\n                const tagName = link.dataset.tagName;\n                this.addTempSelection(tagId, tagName);\n            });\n        });\n\n        // Remove temp selection.\n        this.popup?.addEventListener('click', (e) => {\n            const removeBtn = e.target.closest('[data-action=\"remove-temp-selection\"]');\n            if (removeBtn) {\n                e.preventDefault();\n                const tagId = removeBtn.dataset.tagId;\n                this.removeTempSelection(tagId);\n            }\n        });\n\n        // Search/filter.\n        this.searchInput?.addEventListener('input', () => {\n            this.filterTags();\n        });\n    }\n\n    /**\n     * Open the popup.\n     */\n    openPopup() {\n        this.popup.classList.remove('d-none');\n        this.searchInput?.focus();\n        this.tempSelections.clear();\n        this.selectedAdditionsPopup.innerHTML = '';\n    }\n\n    /**\n     * Close the popup.\n     */\n    closePopup() {\n        this.popup.classList.add('d-none');\n        this.searchInput.value = '';\n        this.filterTags();\n        this.tempSelections.clear();\n        this.selectedAdditionsPopup.innerHTML = '';\n    }\n\n    /**\n     * Add a temporary selection.\n     *\n     * @param {string} tagId\n     * @param {string} tagName\n     */\n    async addTempSelection(tagId, tagName) {\n        // Check if already exists in table.\n        const existingCheckbox = this.tbody.querySelector(`input[data-tag-id=\"${tagId}\"]`);\n        if (existingCheckbox) {\n            return;\n        }\n\n        // Check if already in temp selections.\n        if (this.tempSelections.has(tagId)) {\n            return;\n        }\n\n        this.tempSelections.add(tagId);\n\n        // Add badge to popup.\n        const context = {\n            tagid: tagId,\n            tagname: tagName,\n            action: 'remove-temp-selection'\n        };\n\n        const {html, js} = await Templates.renderForPromise('mod_projetvet/tagselect_badge', context);\n        Templates.appendNodeContents(this.selectedAdditionsPopup, html, js);\n    }\n\n    /**\n     * Remove a temporary selection.\n     *\n     * @param {string} tagId\n     */\n    removeTempSelection(tagId) {\n        this.tempSelections.delete(tagId);\n\n        // Remove badge.\n        const badge = this.selectedAdditionsPopup.querySelector(`[data-tag-id=\"${tagId}\"]`);\n        if (badge) {\n            badge.closest('.badge').remove();\n        }\n    }\n\n    /**\n     * Save additions to the table.\n     */\n    async saveAdditions() {\n        if (this.tempSelections.size === 0) {\n            this.closePopup();\n            return;\n        }\n\n        // Get all tag data from the popup links.\n        const tagList = this.popup.querySelector('[data-region=\"tagconfirm-tag-list\"]');\n        const allLinks = tagList.querySelectorAll('[data-action=\"select-addition\"]');\n\n        // Group selections by their group heading.\n        const groupedAdditions = new Map();\n\n        allLinks.forEach(link => {\n            const tagId = link.dataset.tagId;\n            if (this.tempSelections.has(tagId)) {\n                const tagName = link.dataset.tagName;\n\n                // Find the group heading (previous sibling with bg-light class).\n                let groupHeading = '';\n                let prev = link.previousElementSibling;\n                while (prev) {\n                    if (prev.classList.contains('bg-light')) {\n                        groupHeading = prev.querySelector('div')?.textContent || '';\n                        break;\n                    }\n                    prev = prev.previousElementSibling;\n                }\n\n                if (!groupedAdditions.has(groupHeading)) {\n                    groupedAdditions.set(groupHeading, []);\n                }\n                groupedAdditions.get(groupHeading).push({tagId, tagName});\n            }\n        });\n\n        // Add rows to table for each group.\n        for (const [groupHeading, items] of groupedAdditions) {\n            // Check if group already exists in table.\n            let groupRow = null;\n            const groupRows = this.tbody.querySelectorAll('tr.table-active');\n            groupRows.forEach(row => {\n                if (row.querySelector('strong')?.textContent === groupHeading) {\n                    groupRow = row;\n                }\n            });\n\n            // If group doesn't exist, create it.\n            if (!groupRow) {\n                groupRow = document.createElement('tr');\n                groupRow.className = 'table-active';\n                groupRow.innerHTML = `<td colspan=\"2\"><strong>${groupHeading}</strong></td>`;\n                this.tbody.appendChild(groupRow);\n            }\n\n            // Add items after the group row.\n            for (const {tagId, tagName} of items) {\n                const row = document.createElement('tr');\n                row.setAttribute('data-tag-id', tagId);\n                row.innerHTML = `\n                    <td>${tagName}</td>\n                    <td class=\"text-center\">\n                        <input type=\"checkbox\"\n                               name=\"${this.elementName}[${tagId}]\"\n                               id=\"${this.elementId}_${tagId}\"\n                               value=\"1\"\n                               checked\n                               class=\"tagconfirm-checkbox\"\n                               data-tag-id=\"${tagId}\">\n                    </td>\n                `;\n\n                // Insert after the group row.\n                groupRow.insertAdjacentElement('afterend', row);\n            }\n        }\n\n        this.closePopup();\n    }\n\n    /**\n     * Filter tags based on search input.\n     */\n    filterTags() {\n        const searchTerm = this.searchInput.value.toLowerCase();\n        const tagList = this.popup.querySelector('[data-region=\"tagconfirm-tag-list\"]');\n        const items = tagList.querySelectorAll('[data-action=\"select-addition\"]');\n\n        items.forEach(item => {\n            const tagName = item.dataset.tagName.toLowerCase();\n            if (tagName.includes(searchTerm)) {\n                item.classList.remove('d-none');\n                this.highlightMatch(item, searchTerm);\n            } else {\n                item.classList.add('d-none');\n            }\n        });\n    }\n\n    /**\n     * Highlight matching text.\n     *\n     * @param {HTMLElement} element\n     * @param {string} searchTerm\n     */\n    highlightMatch(element, searchTerm) {\n        const tagName = element.dataset.tagName;\n        if (!searchTerm) {\n            element.innerHTML = tagName;\n            return;\n        }\n\n        const index = tagName.toLowerCase().indexOf(searchTerm);\n        if (index === -1) {\n            element.innerHTML = tagName;\n            return;\n        }\n\n        const before = tagName.slice(0, index);\n        const match = tagName.slice(index, index + searchTerm.length);\n        const after = tagName.slice(index + searchTerm.length);\n        element.innerHTML = `${before}<strong>${match}</strong>${after}`;\n    }\n}\n\nconst init = (elementId, elementName) => {\n    new TagConfirm(elementId, elementName);\n};\n\nexport default {\n    init: init\n};\n"],"names":["TagConfirm","constructor","elementId","elementName","wrapper","document","querySelector","this","popup","searchInput","_this$popup","selectedAdditionsPopup","_this$popup2","table","tbody","tempSelections","Set","addEventListeners","addEventListener","openPopup","querySelectorAll","forEach","btn","closePopup","saveAdditions","link","e","preventDefault","tagId","dataset","tagName","addTempSelection","removeBtn","target","closest","removeTempSelection","filterTags","classList","remove","focus","clear","innerHTML","add","value","has","context","tagid","tagname","action","html","js","Templates","renderForPromise","appendNodeContents","delete","badge","size","allLinks","groupedAdditions","Map","groupHeading","prev","previousElementSibling","contains","textContent","set","get","push","items","groupRow","row","createElement","className","appendChild","setAttribute","insertAdjacentElement","searchTerm","toLowerCase","item","includes","highlightMatch","element","index","indexOf","before","slice","match","length","after","init"],"mappings":"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"}